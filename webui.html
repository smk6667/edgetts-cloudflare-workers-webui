<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TTS 服务终极测试页面 (v2.4 - 稳定流式版)</title>
    <style>
      :root {
        --primary-color: #007bff;
        --success-color: #28a745;
        --error-color: #dc3545;
        --light-gray: #f8f9fa;
        --gray: #6c757d;
        --border-color: #dee2e6;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: var(--light-gray);
        color: #343a40;
        line-height: 1.6;
        display: flex;
        justify-content: center;
        padding: 2rem;
        margin: 0;
      }
      .container {
        max-width: 800px;
        width: 100%;
        background-color: #ffffff;
        padding: 2.5rem;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 2rem;
        font-weight: 700;
      }
      .form-group {
        margin-bottom: 1.5rem;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      input[type="text"],
      input[type="password"],
      select,
      textarea {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      input[type="text"]:focus,
      input[type="password"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
      }
      textarea {
        resize: vertical;
        min-height: 150px;
      }
      .textarea-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: var(--gray);
        margin-top: 0.5rem;
      }
      #clear-text {
        background: none;
        border: none;
        color: var(--primary-color);
        cursor: pointer;
        padding: 0.2rem;
      }
      .grid-layout {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }
      .slider-group {
        display: flex;
        align-items: center;
        gap: 1rem;
      }
      .slider-group input[type="range"] {
        flex-grow: 1;
      }
      .slider-group span {
        font-weight: 500;
        min-width: 40px;
        text-align: right;
      }
      .button-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-top: 2rem;
      }
      button {
        padding: 0.9rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      button:active {
        transform: scale(0.97);
      }
      #btn-generate {
        background-color: #6c757d;
        color: white;
      }
      #btn-stream {
        background-color: var(--success-color);
        color: white;
      }
      button:hover {
        opacity: 0.9;
      }
      #status {
        margin-top: 1.5rem;
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        display: none;
      }
      .status-info {
        background-color: #e7f3ff;
        color: #004085;
      }
      .status-success {
        background-color: #d4edda;
        color: #155724;
      }
      .status-error {
        background-color: #f8d7da;
        color: #721c24;
      }
      audio {
        width: 100%;
        margin-top: 1.5rem;
        display: none;
      }
      details {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        background-color: var(--light-gray);
      }
      summary {
        font-weight: 600;
        cursor: pointer;
        color: #333;
      }
      .checkbox-grid {
        margin-top: 1rem;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.8rem;
      }
      #curl-box {
        position: relative;
        background-color: #212529;
        color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: "SF Mono", "Menlo", "Monaco", "Consolas", monospace;
        font-size: 0.9rem;
      }
      #copy-curl {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background-color: #495057;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 0.4rem 0.8rem;
        cursor: pointer;
      }
      #copy-curl:hover {
        background-color: #343a40;
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>TTS 服务终极测试页面 (v2.4)</h1>

      <details>
        <summary>API 配置</summary>
        <div class="form-group" style="margin-top: 1rem">
          <label for="baseUrl">API Base URL</label>
          <input type="text" id="baseUrl" value="https://你的域名" />
        </div>
        <div class="form-group" style="margin-bottom: 0">
          <label for="apiKey">API Key</label>
          <input type="password" id="apiKey" value="你的密钥" />
        </div>
      </details>

      <div class="form-group">
        <label for="inputText">输入文本</label>
        <textarea id="inputText">
请在这里输入文本，目前尽可能不要超过 1.5w 字每次 不然会报错 。音色映射可以自行修改 workers 的配置</textarea
        >
        <div class="textarea-footer">
          <span id="char-count">0 字符</span>
          <button id="clear-text">清除</button>
        </div>
      </div>

      <div class="grid-layout">
        <div class="form-group">
          <label for="voice">选择音色 (Model)</label>
          <select id="voice">
            <option value="tts-1-shimmer">shimmer (温柔女声)</option>
            <option value="tts-1-alloy" selected>alloy (专业男声)</option>
            <option value="tts-1-fable">fable (激情男声)</option>
            <option value="tts-1-onyx">onyx (活泼女声)</option>
            <option value="tts-1-nova">nova (阳光男声)</option>
            <option value="tts-1-echo">echo (东北女声)</option>
          </select>
        </div>
        <div class="form-group">
          <label>语速</label>
          <div class="slider-group">
            <input
              type="range"
              id="speed"
              min="0.25"
              max="2.0"
              value="1.0"
              step="0.05"
            />
            <span id="speed-value">1.00</span>
          </div>
        </div>
        <div class="form-group">
          <label>音调</label>
          <div class="slider-group">
            <input
              type="range"
              id="pitch"
              min="0.5"
              max="1.5"
              value="1.0"
              step="0.05"
            />
            <span id="pitch-value">1.00</span>
          </div>
        </div>
      </div>

      <details>
        <summary>高级文本清理选项</summary>
        <div class="checkbox-grid">
          <label
            ><input type="checkbox" id="removeMarkdown" checked /> 移除
            Markdown</label
          >
          <label
            ><input type="checkbox" id="removeEmoji" checked /> 移除
            Emoji</label
          >
          <label
            ><input type="checkbox" id="removeUrls" checked /> 移除 URL</label
          >
          <label
            ><input type="checkbox" id="removeLineBreaks" checked />
            移除所有空白/换行</label
          >
          <label
            ><input type="checkbox" id="removeCitation" checked />
            移除引用标记数字</label
          >
        </div>
        <div class="form-group" style="margin-top: 1rem; margin-bottom: 0">
          <label for="customKeywords">自定义移除关键词 (逗号分隔)</label>
          <input type="text" id="customKeywords" placeholder="例如: ABC,XYZ" />
        </div>
      </details>

      <div class="button-group">
        <button id="btn-generate">生成语音 (标准)</button>
        <button id="btn-stream">生成语音 (流式)</button>
      </div>

      <div id="status"></div>
      <audio id="audioPlayer" controls></audio>

      <details id="curl-details" style="margin-top: 2rem">
        <summary>cURL 命令示例 (固定格式)</summary>
        <pre
          id="curl-box"
        ><code>curl --location 'https://your-worker-url/v1/audio/speech' \
--header 'Authorization: Bearer YOUR_API_KEY' \
--header 'Content-Type: application/json' \
--data '{
    "model": "tts-1-alloy",
    "input": "你好，世界！",
    "stream": true
}' \
--output speech.mp3</code></pre>
        <button id="copy-curl">复制</button>
      </details>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const elements = {
          baseUrl: document.getElementById("baseUrl"),
          apiKey: document.getElementById("apiKey"),
          inputText: document.getElementById("inputText"),
          charCount: document.getElementById("char-count"),
          clearText: document.getElementById("clear-text"),
          voice: document.getElementById("voice"),
          speed: document.getElementById("speed"),
          speedValue: document.getElementById("speed-value"),
          pitch: document.getElementById("pitch"),
          pitchValue: document.getElementById("pitch-value"),
          btnGenerate: document.getElementById("btn-generate"),
          btnStream: document.getElementById("btn-stream"),
          status: document.getElementById("status"),
          audioPlayer: document.getElementById("audioPlayer"),
          removeMarkdown: document.getElementById("removeMarkdown"),
          removeEmoji: document.getElementById("removeEmoji"),
          removeUrls: document.getElementById("removeUrls"),
          removeLineBreaks: document.getElementById("removeLineBreaks"),
          removeCitation: document.getElementById("removeCitation"),
          customKeywords: document.getElementById("customKeywords"),
          curlBox: document.querySelector("#curl-box code"),
          copyCurl: document.getElementById("copy-curl"),
        };

        const updateCharCount = () =>
          (elements.charCount.textContent = `${elements.inputText.value.length} 字符`);

        elements.inputText.addEventListener("input", updateCharCount);
        elements.clearText.addEventListener("click", () => {
          elements.inputText.value = "";
          updateCharCount();
        });

        elements.speed.addEventListener(
          "input",
          () =>
            (elements.speedValue.textContent = parseFloat(
              elements.speed.value
            ).toFixed(2))
        );
        elements.pitch.addEventListener(
          "input",
          () =>
            (elements.pitchValue.textContent = parseFloat(
              elements.pitch.value
            ).toFixed(2))
        );

        elements.btnGenerate.addEventListener("click", () =>
          generateSpeech(false)
        );
        elements.btnStream.addEventListener("click", () =>
          generateSpeech(true)
        );
        elements.copyCurl.addEventListener("click", copyCurlToClipboard);

        function copyCurlToClipboard() {
          navigator.clipboard
            .writeText(elements.curlBox.textContent)
            .then(() => {
              elements.copyCurl.textContent = "已复制!";
              setTimeout(() => (elements.copyCurl.textContent = "复制"), 2000);
            })
            .catch((err) => console.error("Could not copy text: ", err));
        }

        function getRequestBody() {
          return {
            model: elements.voice.value,
            input: elements.inputText.value.trim(),
            speed: parseFloat(elements.speed.value),
            pitch: parseFloat(elements.pitch.value),
            cleaning_options: {
              remove_markdown: elements.removeMarkdown.checked,
              remove_emoji: elements.removeEmoji.checked,
              remove_urls: elements.removeUrls.checked,
              remove_line_breaks: elements.removeLineBreaks.checked,
              remove_citation_numbers: elements.removeCitation.checked,
              custom_keywords: elements.customKeywords.value,
            },
          };
        }

        async function generateSpeech(isStream) {
          const baseUrl = elements.baseUrl.value.trim();
          const apiKey = elements.apiKey.value.trim();
          const text = elements.inputText.value.trim();

          if (!baseUrl || !apiKey || !text) {
            updateStatus("请填写 API 配置和输入文本", "error");
            return;
          }

          const requestBody = getRequestBody();
          requestBody.stream = isStream;

          elements.audioPlayer.style.display = "none";
          elements.audioPlayer.src = "";
          updateStatus("正在连接服务器...", "info");

          try {
            if (isStream) {
              await playStreamWithMSE(baseUrl, apiKey, requestBody);
            } else {
              await playStandard(baseUrl, apiKey, requestBody);
            }
          } catch (error) {
            console.error("Error generating speech:", error);
            updateStatus(`错误: ${error.message}`, "error");
          }
        }

        async function playStandard(baseUrl, apiKey, body) {
          const response = await fetch(`${baseUrl}/v1/audio/speech`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${apiKey}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
          });
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(
              errorData.error.message ||
                `HTTP error! status: ${response.status}`
            );
          }
          const blob = await response.blob();
          const audioUrl = URL.createObjectURL(blob);
          elements.audioPlayer.src = audioUrl;
          elements.audioPlayer.style.display = "block";
          elements.audioPlayer.play();
          updateStatus("播放中...", "success");
        }

        // This is the new, robust MSE implementation
        async function playStreamWithMSE(baseUrl, apiKey, body) {
          const mediaSource = new MediaSource();
          elements.audioPlayer.src = URL.createObjectURL(mediaSource);
          elements.audioPlayer.style.display = "block";

          mediaSource.addEventListener(
            "sourceopen",
            async () => {
              URL.revokeObjectURL(elements.audioPlayer.src);
              const sourceBuffer = mediaSource.addSourceBuffer("audio/mpeg");

              try {
                const response = await fetch(`${baseUrl}/v1/audio/speech`, {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${apiKey}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(body),
                });

                if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(
                    errorData.error.message ||
                      `HTTP error! status: ${response.status}`
                  );
                }

                updateStatus("已连接，接收数据中...", "info");
                elements.audioPlayer
                  .play()
                  .catch((e) => console.warn("Autoplay was prevented:", e));

                const reader = response.body.getReader();

                // Robust pump function to handle backpressure
                const pump = async () => {
                  const { done, value } = await reader.read();

                  if (done) {
                    if (
                      mediaSource.readyState === "open" &&
                      !sourceBuffer.updating
                    ) {
                      mediaSource.endOfStream();
                    }
                    updateStatus("播放完毕！", "success");
                    return;
                  }

                  // Wait for the buffer to be ready before appending
                  if (sourceBuffer.updating) {
                    await new Promise((resolve) =>
                      sourceBuffer.addEventListener("updateend", resolve, {
                        once: true,
                      })
                    );
                  }

                  sourceBuffer.appendBuffer(value);
                  updateStatus("正在流式播放...", "success");
                };

                // Listen for 'updateend' to call the next pump, creating a controlled loop
                sourceBuffer.addEventListener("updateend", pump);
                // Start the first pump
                await pump();
              } catch (error) {
                console.error("Error in MSE streaming:", error);
                updateStatus(`错误: ${error.message}`, "error");
                if (mediaSource.readyState === "open") {
                  try {
                    mediaSource.endOfStream();
                  } catch (e) {}
                }
              }
            },
            { once: true }
          );
        }

        function updateStatus(message, type) {
          elements.status.textContent = message;
          elements.status.className = `status-${type}`;
          elements.status.style.display = "block";
        }

        // Initial setup
        updateCharCount();
      });
    </script>
  </body>
</html>
